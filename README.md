# å·¥ä¸šä»ªè¡¨è¯»æ•°è‡ªåŠ¨è¯†åˆ«ç³»ç»Ÿ

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ çš„å·¥ä¸šä»ªè¡¨è¯»æ•°è‡ªåŠ¨è¯†åˆ«ç³»ç»Ÿï¼Œèƒ½å¤Ÿä»ç›‘æ§æ‘„åƒå¤´ç”»é¢ä¸­è‡ªåŠ¨æå–å‹åŠ›è¡¨ã€æ¸©åº¦è®¡ç­‰åœ†å½¢æŒ‡é’ˆå¼ä»ªè¡¨çš„è¯»æ•°ã€‚ç³»ç»Ÿé‡‡ç”¨ä¸‰é˜¶æ®µå¤„ç†æµç¨‹ï¼Œç»“åˆäº†YOLOç›®æ ‡æ£€æµ‹ã€DeepLabV3+è¯­ä¹‰åˆ†å‰²å’Œå‡ ä½•ç®—æ³•ï¼Œå®ç°ä»å›¾åƒåˆ°æ•°å€¼çš„å®Œæ•´è½¬æ¢ã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

- **å®Œæ•´çš„AIæµæ°´çº¿**ï¼šæ£€æµ‹ â†’ åˆ†å‰² â†’ è¯»æ•°æå–
- **ONNXæ¨ç†åŠ é€Ÿ**ï¼šæ”¯æŒONNX Runtimeï¼Œé¿å…PyTorchä¾èµ–é—®é¢˜
- **æ™ºèƒ½åå¤„ç†**ï¼šè‡ªåŠ¨å»é™¤åˆ†å‰²å™ªå£°ï¼Œä¼˜åŒ–æŒ‡é’ˆå’Œåˆ»åº¦è¾¹ç•Œ
- **Webç•Œé¢**ï¼šåŸºäºGradioçš„å‹å¥½ç”¨æˆ·ç•Œé¢
- **Apple Siliconä¼˜åŒ–**ï¼šæ”¯æŒMPSåŠ é€Ÿï¼ˆM1/M2èŠ¯ç‰‡ï¼‰
- **çµæ´»é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰åˆ»åº¦èŒƒå›´å’Œåå¤„ç†å‚æ•°

## æŠ€æœ¯æ¶æ„

### å¤„ç†æµç¨‹
```
åŸå§‹å›¾åƒ â†’ ä»ªè¡¨æ£€æµ‹(YOLO) â†’ åŒºåŸŸè£å‰ª â†’ è¯­ä¹‰åˆ†å‰²(ONNX) â†’ åå¤„ç†ä¼˜åŒ– â†’ è¯»æ•°è®¡ç®— â†’ æœ€ç»ˆç»“æœ
```

### ä¸‰ä¸ªæ ¸å¿ƒé˜¶æ®µ

#### é˜¶æ®µ1ï¼šä»ªè¡¨ä½ç½®æ£€æµ‹ï¼ˆYOLOv10ï¼‰
- **åŠŸèƒ½**ï¼šä»å®Œæ•´çš„ç›‘æ§ç”»é¢ä¸­å®šä½å¹¶æ¡†é€‰å‡ºä»ªè¡¨åŒºåŸŸ
- **æŠ€æœ¯**ï¼šYOLOv10 ç›®æ ‡æ£€æµ‹æ¨¡å‹
- **è¾“å…¥**ï¼šåŸå§‹ç›‘æ§å›¾åƒ
- **è¾“å‡º**ï¼šä»ªè¡¨çš„è¾¹ç•Œæ¡†åæ ‡å’Œç½®ä¿¡åº¦
- **ç‰¹ç‚¹**ï¼šè‡ªåŠ¨æ£€æµ‹å¤šä¸ªä»ªè¡¨ï¼Œæ”¯æŒæ‰¹é‡å¤„ç†

#### é˜¶æ®µ2ï¼šæŒ‡é’ˆä¸åˆ»åº¦åˆ†å‰²ï¼ˆDeepLabV3+ + ONNXï¼‰
- **åŠŸèƒ½**ï¼šå¯¹æ£€æµ‹åˆ°çš„ä»ªè¡¨åŒºåŸŸè¿›è¡Œåƒç´ çº§è¯­ä¹‰åˆ†å‰²
- **æŠ€æœ¯**ï¼šDeepLabV3+ (ResNet50) + ONNX Runtimeæ¨ç†
- **åˆ†å‰²ç±»åˆ«**ï¼š
  - èƒŒæ™¯ï¼ˆBackgroundï¼‰
  - æŒ‡é’ˆï¼ˆPointerï¼‰
  - åˆ»åº¦çº¿ï¼ˆScaleï¼‰
- **åå¤„ç†åŠŸèƒ½**ï¼š
  - å™ªå£°ç‚¹å»é™¤ï¼ˆå¼€è¿ç®—ï¼‰
  - è¿é€šåŸŸåˆ†æï¼ˆä¿ç•™ä¸»è¦åŒºåŸŸï¼‰
  - æŒ‡é’ˆç»†åŒ–ï¼ˆè½»åº¦è…èš€ï¼‰
  - åˆ»åº¦æ”¶ç¼©ï¼ˆé˜²æ­¢è¾¹ç•Œå¤–ç§»ï¼‰
  - å­”æ´å¡«å……

#### é˜¶æ®µ3ï¼šè¯»æ•°è®¡ç®—ä¸è½¬æ¢
- **åŠŸèƒ½**ï¼šåŸºäºåˆ†å‰²ç»“æœè®¡ç®—æŒ‡é’ˆè§’åº¦å¹¶è½¬æ¢ä¸ºå®é™…è¯»æ•°
- **ç®—æ³•**ï¼š
  - æŒ‡é’ˆä¸­å¿ƒç‚¹å®šä½
  - æŒ‡é’ˆæ–¹å‘è§’åº¦è®¡ç®—
  - åˆ»åº¦èŒƒå›´æ˜ å°„
  - è§’åº¦æ’å€¼ä¸è¯»æ•°è¾“å‡º

## é¡¹ç›®ç»“æ„

```
pointMeterDetection/
â”œâ”€â”€ README.md                 # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ requirements.txt          # Pythonä¾èµ–åŒ…
â”œâ”€â”€ pyproject.toml           # uvé¡¹ç›®é…ç½®
â”œâ”€â”€ app.py                   # Gradio Webåº”ç”¨ä¸»ç¨‹åº
â”œâ”€â”€ config/                  # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ detection_config.yaml # YOLOæ£€æµ‹é…ç½®
â”‚   â””â”€â”€ segmentation_config.yaml # åˆ†å‰²æ¨¡å‹é…ç½®
â”œâ”€â”€ data/                    # æ•°æ®é›†ç›®å½•
â”‚   â”œâ”€â”€ detection/           # æ£€æµ‹æ•°æ®é›†ï¼ˆCOCOæ ¼å¼ï¼‰
â”‚   â”‚   â”œâ”€â”€ train2017/       # è®­ç»ƒå›¾åƒ
â”‚   â”‚   â”œâ”€â”€ val2017/         # éªŒè¯å›¾åƒ
â”‚   â”‚   â””â”€â”€ annotations/     # æ ‡æ³¨æ–‡ä»¶
â”‚   â””â”€â”€ segmentation/        # åˆ†å‰²æ•°æ®é›†ï¼ˆPascal VOCæ ¼å¼ï¼‰
â”‚       â”œâ”€â”€ JPEGImages/      # åŸå§‹å›¾åƒ
â”‚       â”œâ”€â”€ SegmentationClass_unified/ # ç»Ÿä¸€åçš„åˆ†å‰²æ ‡æ³¨
â”‚       â””â”€â”€ ImageSets/       # æ•°æ®é›†åˆ’åˆ†
â”œâ”€â”€ scripts/                 # è®­ç»ƒå’Œå·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ train_detection.py   # æ£€æµ‹æ¨¡å‹è®­ç»ƒ
â”‚   â”œâ”€â”€ train_segmentation.py # åˆ†å‰²æ¨¡å‹è®­ç»ƒï¼ˆæ”¯æŒ--export-onlyï¼‰
â”‚   â””â”€â”€ extract_meter_reading.py # è¯»æ•°æå–ç®—æ³•
â”œâ”€â”€ tools/                   # æ•°æ®å¤„ç†å·¥å…·
â”‚   â””â”€â”€ data_preparation/    # æ•°æ®é¢„å¤„ç†å·¥å…·
â””â”€â”€ outputs/                 # è¾“å‡ºç»“æœ
    â”œâ”€â”€ checkpoints/         # æ¨¡å‹æ£€æŸ¥ç‚¹
    â”œâ”€â”€ segmentation/        # åˆ†å‰²æ¨¡å‹è¾“å‡º
    â”‚   â”œâ”€â”€ best_model.pth   # æœ€ä½³PyTorchæ¨¡å‹
    â”‚   â””â”€â”€ exported/        # å¯¼å‡ºçš„æ¨¡å‹
    â”‚       â””â”€â”€ segmentation_model.onnx # ONNXæ¨¡å‹
    â””â”€â”€ results/             # æ¨ç†ç»“æœ
```

## ç¯å¢ƒè¦æ±‚

### ç¡¬ä»¶è¦æ±‚
- **æ¨è**ï¼šApple Silicon (M1/M2) æˆ– CUDAå…¼å®¹GPU
- **æœ€ä½**ï¼š4GBå†…å­˜ï¼Œç°ä»£CPU
- **å­˜å‚¨**ï¼š2GBå¯ç”¨ç©ºé—´

### è½¯ä»¶è¦æ±‚
- Python 3.11+
- æ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼šmacOS, Linux, Windows

### ä¸»è¦ä¾èµ–
```
torch>=2.0.0
torchvision>=0.15.0
ultralytics>=8.0.0
onnxruntime>=1.22.0
opencv-python>=4.6.0
gradio>=4.0.0
matplotlib>=3.5.0
numpy>=1.21.0
PyYAML>=6.0
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå®‰è£…

#### ä½¿ç”¨uvï¼ˆæ¨èï¼‰
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/chijiang/pointerMeterReader.git
cd pointMeterDetection

# ä½¿ç”¨uvåˆ›å»ºç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
uv sync
```

#### ä½¿ç”¨pip
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/chijiang/pointerMeterReader.git
cd pointMeterDetection

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# æˆ– .venv\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. å¯åŠ¨Webåº”ç”¨

```bash
# å¯åŠ¨Gradio Webç•Œé¢
python app.py
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—® `http://localhost:7860` ä½¿ç”¨Webç•Œé¢è¿›è¡Œä»ªè¡¨è¯»æ•°è¯†åˆ«ã€‚

### 3. æ¨¡å‹è®­ç»ƒï¼ˆå¯é€‰ï¼‰

#### æ£€æµ‹æ¨¡å‹è®­ç»ƒ
```bash
# éªŒè¯æ£€æµ‹æ•°æ®é›†
python tools/data_preparation/check_data.py

# å¼€å§‹è®­ç»ƒYOLOv10æ£€æµ‹æ¨¡å‹
python scripts/train_detection.py --config config/detection_config.yaml

# è¯„ä¼°ç°æœ‰æ¨¡å‹
python scripts/train_detection.py --eval-only --model-path outputs/checkpoints/detection/meter_detection_v1/weights/best.pt --visualize
```

#### åˆ†å‰²æ¨¡å‹è®­ç»ƒ
```bash
# æ£€æŸ¥åˆ†å‰²æ•°æ®é›†
python tools/data_preparation/check_segmentation_data.py --data_dir data/segmentation --mask_dir SegmentationClass_unified --visualize

# å¼€å§‹è®­ç»ƒDeepLabV3+åˆ†å‰²æ¨¡å‹
python scripts/train_segmentation.py --config config/segmentation_config.yaml

# å¯¼å‡ºONNXæ¨¡å‹ï¼ˆç”¨äºåŠ é€Ÿæ¨ç†ï¼‰
python scripts/train_segmentation.py --export-only --export-formats onnx torchscript
```

## ğŸ“Š åŠŸèƒ½è¯¦è§£

### Webç•Œé¢åŠŸèƒ½

1. **å›¾åƒä¸Šä¼ **ï¼šæ”¯æŒJPGã€PNGç­‰å¸¸è§æ ¼å¼
2. **å‚æ•°è°ƒèŠ‚**ï¼š
   - æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼
   - åˆ»åº¦æœ€å°/æœ€å¤§å€¼è®¾ç½®
3. **å¯è§†åŒ–æµç¨‹**ï¼š
   - æ£€æµ‹ç»“æœï¼ˆè¾¹ç•Œæ¡†ï¼‰
   - è£å‰ªçš„ä»ªè¡¨åŒºåŸŸ
   - åˆ†å‰²æ©ç ï¼ˆå¸¦ç»Ÿè®¡ä¿¡æ¯ï¼‰
   - æœ€ç»ˆè¯»æ•°ç»“æœ
4. **ç»“æœè¾“å‡º**ï¼šæ•°å€¼è¯»æ•°å’Œç½®ä¿¡åº¦

### åå¤„ç†é…ç½®

ç³»ç»Ÿæ”¯æŒçµæ´»çš„åå¤„ç†é…ç½®ï¼Œå¯åœ¨ `app.py` ä¸­è°ƒæ•´ï¼š

```python
post_process_config = {
    'remove_noise': True,           # å»é™¤å™ªå£°ç‚¹
    'keep_largest_component': False, # ä¿ç•™æœ€å¤§è¿é€šåŸŸ
    'pointer_erosion': 1,           # æŒ‡é’ˆè…èš€å¼ºåº¦
    'scale_erosion': 3,             # åˆ»åº¦è…èš€å¼ºåº¦ï¼ˆé˜²å¤–ç§»ï¼‰
    'fill_holes': False,            # å¡«å……å°å­”æ´
    'connect_scale_lines': False    # è¿æ¥æ–­è£‚åˆ»åº¦çº¿
}
```

### æ•°æ®é›†æ ¼å¼

#### æ£€æµ‹æ•°æ®é›†ï¼ˆCOCOæ ¼å¼ï¼‰
```json
{
    "images": [{"id": 1, "file_name": "image1.jpg", "width": 1920, "height": 1080}],
    "annotations": [{"id": 1, "image_id": 1, "category_id": 1, "bbox": [x, y, w, h]}],
    "categories": [{"id": 1, "name": "meter", "supercategory": "instrument"}]
}
```

#### åˆ†å‰²æ•°æ®é›†ï¼ˆPascal VOCæ ¼å¼ï¼‰
- å›¾åƒï¼š`JPEGImages/xxx.jpg`
- æ ‡æ³¨ï¼š`SegmentationClass_unified/xxx.png`
- ç±»åˆ«æ˜ å°„ï¼š`0=èƒŒæ™¯`, `1=æŒ‡é’ˆ`, `2=åˆ»åº¦`

## ğŸ”§ é«˜çº§ä½¿ç”¨

### æµ‹è¯•åå¤„ç†æ•ˆæœ
```bash
# è¿è¡Œåå¤„ç†æ•ˆæœæµ‹è¯•
python test_post_processing.py
```

### ONNXæ¨¡å‹æµ‹è¯•
```bash
# æµ‹è¯•ONNXæ¨¡å‹åŠ è½½å’Œæ¨ç†
python test_onnx_simple.py
```

### å•ç‹¬ä½¿ç”¨è¯»æ•°æå–ç®—æ³•
```python
from scripts.extract_meter_reading import MeterReader

reader = MeterReader(scale_range=(0.0, 1.6))
reading = reader.process_single_meter(image, segmentation_mask)
```

## ğŸ¯ æ€§èƒ½æŒ‡æ ‡

### æ£€æµ‹æ¨¡å‹
- **æ•°æ®é›†**ï¼š1836å¼ å›¾åƒï¼Œ2082ä¸ªæ ‡æ³¨
- **è®­ç»ƒé›†**ï¼š1670å¼ å›¾åƒï¼Œ1898ä¸ªæ ‡æ³¨
- **éªŒè¯é›†**ï¼š166å¼ å›¾åƒï¼Œ184ä¸ªæ ‡æ³¨

### åˆ†å‰²æ¨¡å‹
- **æ¶æ„**ï¼šDeepLabV3+ (ResNet50)
- **è¾“å…¥å°ºå¯¸**ï¼š224Ã—224
- **è¾“å‡ºæ ¼å¼**ï¼šONNX (160MB)
- **æ¨ç†è®¾å¤‡**ï¼šCPU/MPS/CUDA

### ç³»ç»Ÿæ€§èƒ½
- **æ£€æµ‹é€Ÿåº¦**ï¼š~60ms/å›¾ï¼ˆYOLOv10ï¼‰
- **åˆ†å‰²é€Ÿåº¦**ï¼š~30ms/å›¾ï¼ˆONNX CPUï¼‰
- **ç«¯åˆ°ç«¯å»¶è¿Ÿ**ï¼š<200ms/å›¾
- **å†…å­˜å ç”¨**ï¼š<2GB

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ONNXæ¨¡å‹åŠ è½½å¤±è´¥**
   ```bash
   pip install onnxruntime
   ```

2. **åˆ†å‰²ç»“æœæœ‰å™ªå£°**
   - è°ƒæ•´åå¤„ç†é…ç½®ä¸­çš„è…èš€å‚æ•°
   - å¯ç”¨å™ªå£°å»é™¤ï¼š`'remove_noise': True`

3. **æ£€æµ‹ä¸åˆ°ä»ªè¡¨**
   - é™ä½ç½®ä¿¡åº¦é˜ˆå€¼
   - æ£€æŸ¥å›¾åƒè´¨é‡å’Œå…‰ç…§æ¡ä»¶

4. **è¯»æ•°ä¸å‡†ç¡®**
   - éªŒè¯åˆ»åº¦èŒƒå›´è®¾ç½®
   - æ£€æŸ¥æŒ‡é’ˆå’Œåˆ»åº¦åˆ†å‰²è´¨é‡

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (å½“å‰ç‰ˆæœ¬)
- âœ… å®Œæ•´çš„ä¸‰é˜¶æ®µè¯†åˆ«æµæ°´çº¿
- âœ… ONNXæ¨ç†æ”¯æŒï¼Œé¿å…PyTorchä¾èµ–é—®é¢˜
- âœ… æ™ºèƒ½åå¤„ç†ï¼Œå»é™¤å™ªå£°å’Œä¼˜åŒ–è¾¹ç•Œ
- âœ… Gradio Webç•Œé¢
- âœ… Apple Silicon (MPS) æ”¯æŒ
- âœ… çµæ´»çš„é…ç½®ç³»ç»Ÿ

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›æœ¬é¡¹ç›®ï¼

---

*æœ¬é¡¹ç›®ä¸“æ³¨äºå·¥ä¸šä»ªè¡¨è¯»æ•°è¯†åˆ«ï¼Œé€‚ç”¨äºå‹åŠ›è¡¨ã€æ¸©åº¦è®¡ã€æµé‡è®¡ç­‰åœ†å½¢æŒ‡é’ˆå¼ä»ªè¡¨çš„è‡ªåŠ¨åŒ–è¯»æ•°åœºæ™¯ã€‚* 